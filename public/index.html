<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Etherboard</title>
  <meta name="description" content="Post it. Let go. Etherboard is an anonymous space for thoughts that disappear." />

  <style>
    :root {
      --bg: #0b0f1a;
      --panel: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --accent: #8be9fd;
      --accent2: #a78bfa;
      --radius: 18px;
      --max: 920px;
      --shadow: 0 20px 40px rgba(0,0,0,0.4);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(139,233,253,0.18), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(167,139,250,0.16), transparent 60%),
        var(--bg);
      min-height: 100vh;
    }

    .wrap { max-width: var(--max); margin: 0 auto; padding: 40px 18px 80px; }

    header { display: flex; align-items: center; gap: 16px; margin-bottom: 28px; }

    .logo {
      width: 48px; height: 48px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(139,233,253,0.95), rgba(167,139,250,0.95));
      box-shadow: var(--shadow);
      display: grid; place-items: center;
    }

    .logo svg { width: 28px; height: 28px; }

    h1 { font-size: 20px; margin: 0; letter-spacing: 0.3px; }
    .tagline { font-size: 13px; color: var(--muted); margin-top: 4px; }

    .hero {
      margin: 24px 0 36px;
      font-size: 18px;
      line-height: 1.5;
      color: var(--muted);
      max-width: 640px;
    }

    .grid { display: grid; gap: 20px; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1.1fr 0.9fr; } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card h2 { margin: 0; font-size: 16px; font-weight: 600; }

    .card-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .card-body { padding: 16px 18px 18px; }

    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      font-size: 14px;
      line-height: 1.45;
      outline: none;
    }

    textarea:focus {
      border-color: rgba(139,233,253,0.6);
      box-shadow: 0 0 0 3px rgba(139,233,253,0.18);
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .meta { font-size: 12px; color: var(--muted); }
    .hint { margin-top: 10px; font-size: 12px; color: var(--muted); line-height: 1.4; }

    button {
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }

    button.primary {
      background: linear-gradient(135deg, rgba(139,233,253,0.28), rgba(167,139,250,0.22));
      border-color: rgba(139,233,253,0.6);
    }

    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    .smallbtn { padding: 8px 10px; font-size: 12px; border-radius: 12px; }

    input[type="file"] { max-width: 100%; color: var(--muted); }

    .preview { margin-top: 10px; display: none; gap: 10px; align-items: center; }
    .thumb {
      width: 74px; height: 74px;
      border-radius: 14px;
      border: 1px solid var(--border);
      object-fit: cover;
      background: rgba(0,0,0,0.25);
    }

    .feed { display: flex; flex-direction: column; gap: 12px; }

    .post {
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 12px 14px;
    }

    .post-text { white-space: pre-wrap; font-size: 14px; line-height: 1.45; }

    .post-img {
      width: 100%;
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      display: block;
    }

    .post-footer {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
      flex-wrap: wrap;
    }

    .updates {
      border-color: rgba(139,233,253,0.30);
      background: linear-gradient(180deg, rgba(139,233,253,0.10), rgba(0,0,0,0.16));
    }

    .updates h3 {
      margin: 0 0 10px 0;
      font-size: 13px;
      letter-spacing: 0.2px;
      color: rgba(255,255,255,0.85);
    }

    .update-item {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.10);
    }

    .update-title { font-weight: 650; margin: 0; font-size: 13px; color: rgba(255,255,255,0.88); }
    .update-body { margin-top: 6px; font-size: 13px; line-height: 1.4; color: rgba(255,255,255,0.74); }
    .update-date { margin-top: 6px; font-family: var(--mono); font-size: 12px; color: rgba(255,255,255,0.60); }

    footer { margin-top: 60px; font-size: 12px; color: var(--muted); text-align: center; line-height: 1.4; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 2C8.5 5.2 7 7.6 7 10.2c0 2.7 2.2 4.8 5 4.8s5-2.1 5-4.8C17 7.6 15.5 5.2 12 2Z" fill="rgba(0,0,0,0.35)"/>
          <path d="M8.5 13.5c.7 2.6 2.5 4.5 3.5 6.5 1-2 2.8-3.9 3.5-6.5" stroke="rgba(0,0,0,0.35)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>Etherboard</h1>
        <div class="tagline">Post it. Let go.</div>
      </div>
    </header>

    <div class="hero">
      Write freely. No accounts. No history. No judgment.
      Everything posted here fades away after one hour.
    </div>

    <div class="grid">
      <!-- Composer -->
      <div class="card">
        <div class="card-header">
          <h2>Post a thought</h2>
          <div class="meta">Images optional</div>
        </div>

        <div class="card-body">
          <textarea id="content" maxlength="500" placeholder="Say what you need to say…"></textarea>

          <div class="row">
            <input id="image" type="file" accept="image/*" />
            <button class="smallbtn" id="clearImageBtn" type="button">Remove image</button>
            <div class="meta" id="status"></div>
          </div>

          <div class="preview" id="previewWrap">
            <img class="thumb" id="previewImg" alt="Selected image preview" />
            <div class="meta" id="previewMeta"></div>
          </div>

          <div class="controls">
            <div class="meta" id="count">0 / 500</div>
            <button class="primary" id="postBtn" type="button">Post</button>
          </div>

          <div class="hint">
            Images are uploaded directly to Etherboard’s server and are removed when the post expires.
          </div>
        </div>
      </div>

      <!-- Updates + Feed -->
      <div class="card">
        <div class="card-header">
          <h2>Live feed</h2>
          <button class="smallbtn" id="refreshBtn" type="button">Refresh</button>
        </div>
        <div class="card-body">
          <div id="announcements"></div>
          <div id="posts" class="feed"></div>
        </div>
      </div>
    </div>

    <footer>
      Etherboard stores nothing permanently. Posts automatically disappear after one hour.
    </footer>
  </div>

  <script>
    const MAX_IMAGE_MB = 3;

    const content = document.getElementById("content");
    const count = document.getElementById("count");
    const postsEl = document.getElementById("posts");

    const imageEl = document.getElementById("image");
    const clearImageBtn = document.getElementById("clearImageBtn");
    const statusEl = document.getElementById("status");

    const previewWrap = document.getElementById("previewWrap");
    const previewImg = document.getElementById("previewImg");
    const previewMeta = document.getElementById("previewMeta");

    const announcementsEl = document.getElementById("announcements");
    const postBtn = document.getElementById("postBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    let selectedFile = null;

    content.addEventListener("input", () => {
      count.textContent = `${content.value.length} / 500`;
    });

    imageEl.addEventListener("change", () => {
      const file = imageEl.files && imageEl.files[0] ? imageEl.files[0] : null;
      selectedFile = null;
      statusEl.textContent = "";

      if (!file) {
        previewWrap.style.display = "none";
        return;
      }

      const mb = file.size / (1024 * 1024);
      if (mb > MAX_IMAGE_MB) {
        imageEl.value = "";
        previewWrap.style.display = "none";
        alert(`Max image size is ${MAX_IMAGE_MB}MB.`);
        return;
      }

      selectedFile = file;
      previewImg.src = URL.createObjectURL(file);
      previewMeta.textContent = `${file.type || "image"} • ${mb.toFixed(2)} MB`;
      previewWrap.style.display = "flex";
    });

    clearImageBtn.addEventListener("click", () => {
      imageEl.value = "";
      selectedFile = null;
      statusEl.textContent = "";
      previewWrap.style.display = "none";
      previewImg.src = "";
      previewMeta.textContent = "";
    });

    async function loadAnnouncements() {
      try {
        const res = await fetch("/announcements", { cache: "no-store" });
        const data = await res.json();
        const pinned = (data.items || []).filter(x => x && x.pinned);

        if (!pinned.length) {
          announcementsEl.innerHTML = "";
          return;
        }

        announcementsEl.innerHTML = `
          <div class="post updates">
            <h3>Updates</h3>
            ${pinned.map(a => `
              <div class="update-item">
                <div class="update-title">${escapeHtml(a.title || "")}</div>
                <div class="update-body">${escapeHtml(a.body || "")}</div>
                <div class="update-date">${escapeHtml(a.date || "")}</div>
              </div>
            `).join("")}
          </div>
        `;
      } catch {
        announcementsEl.innerHTML = "";
      }
    }

    async function loadPosts() {
      const res = await fetch("/posts", { cache: "no-store" });
      const posts = await res.json();

      postsEl.innerHTML = posts.map(p => `
        <div class="post">
          ${p.content ? `<div class="post-text">${escapeHtml(p.content)}</div>` : ``}
          ${p.image_url ? `<img class="post-img" src="${escapeAttr(p.image_url)}" alt="User uploaded image" loading="lazy" />` : ``}
          <div class="post-footer">
            <span>${new Date(p.created_at).toLocaleTimeString()}</span>
            <span>${Math.max(0, Math.floor((p.expires_at - Date.now()) / 60000))}m left</span>
          </div>
        </div>
      `).join("");
    }

    async function submit() {
      const text = content.value.trim();
      if (!text && !selectedFile) return;

      postBtn.disabled = true;
      refreshBtn.disabled = true;
      statusEl.textContent = "";

      try {
        // Send multipart/form-data to the server: fields "content" and optional file "image"
        const form = new FormData();
        form.append("content", text);
        if (selectedFile) form.append("image", selectedFile);

        statusEl.textContent = selectedFile ? "Uploading…" : "Posting…";

        const res = await fetch("/posts", {
          method: "POST",
          body: form
          // Do NOT set Content-Type; browser sets the multipart boundary automatically.
        });

        const raw = await res.text();
        let data = {};
        try { data = JSON.parse(raw); } catch {}

        if (!res.ok) {
          alert(`POST /posts failed (${res.status}). Response:\n\n${raw}`);
          statusEl.textContent = "";
          return;
        }
        if (data.error) {
          alert(`Error: ${data.error}`);
          statusEl.textContent = "";
          return;
        }

        content.value = "";
        count.textContent = "0 / 500";
        clearImageBtn.click();
        statusEl.textContent = "";

        await loadPosts();
      } catch (e) {
        alert(`Network error: ${e.message}`);
        statusEl.textContent = "";
      } finally {
        postBtn.disabled = false;
        refreshBtn.disabled = false;
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m =>
        ({ "&":"&amp;","<":"&lt;",">":"&gt;", "\"":"&quot;","'":"&#039;" }[m])
      );
    }

    function escapeAttr(str) {
      return String(str).replace(/"/g, "&quot;");
    }

    document.getElementById("postBtn").addEventListener("click", submit);
    refreshBtn.addEventListener("click", async () => {
      await loadAnnouncements();
      await loadPosts();
    });

    loadAnnouncements();
    loadPosts();
    setInterval(loadPosts, 5000);
  </script>
</body>
</html>